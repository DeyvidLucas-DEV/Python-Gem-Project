
import { useRef, useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation, Autoplay } from 'swiper/modules';
import { motion } from 'framer-motion';
import 'swiper/css';
import 'swiper/css/navigation';
import styles from './Team.module.css';

import api from "../../services/api"

// URL base da API
const API_BASE_URL = 'http://161.97.180.189';

// Helper para montar URL de imagem
const getImageUrl = (url) => {
  if (!url) return null;
  return `${API_BASE_URL}${url}`;
};

const Team = ({ modo = "grupos" }) => {
  const swiperRef = useRef(null);
  const prevRef = useRef(null);
  const nextRef = useRef(null);

  const [teamMembers, setTeamMembers] = useState([])
  const [groupData, setGroupData] = useState([])
  const [loading, setLoading] = useState(true);

  const fetchData = async () => {
    try {
      const [teamRes, groupRes] = await Promise.all([
        api.get("/membros/"),
        api.get("/subgrupos/")
      ])
      setTeamMembers(teamRes.data.items)
      setGroupData(groupRes.data.items)
    } catch (error) {
      console.error("Erro ao carregar dados: ", error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchData()

    // Refresh a cada 50 minutos para renovar URLs assinadas
    const interval = setInterval(fetchData, 50 * 60 * 1000);
    return () => clearInterval(interval);
  }, [])

  useEffect(() => {
    const equalizeCardHeights = () => {
      const cards = document.querySelectorAll('.swiper-slide .card');
      if (!cards.length) return;

      cards.forEach(card => {
        card.style.height = 'auto';
      });

      const maxHeight = Math.max(...Array.from(cards).map(card => card.offsetHeight));

      cards.forEach(card => {
        card.style.height = `${maxHeight}px`;
      });
    };

    setTimeout(() => {
      equalizeCardHeights();
    }, 100);

    window.addEventListener('resize', equalizeCardHeights);
    return () => {
      window.removeEventListener('resize', equalizeCardHeights);
    };
  }, []);

  if (loading) return <p>Carregando...</p>;

  const highlightPartialSlide = (swiper) => {
    swiper.slides.forEach((slide) => {
      slide.classList.remove('dimmed');
    });
    const partialIndex = swiper.activeIndex + 4;
    const partialSlide = swiper.slides[partialIndex];
    if (partialSlide) {
      partialSlide.classList.add('dimmed');
    }
  };


  // MODO GERAL (carrossel home)
  if (modo === "geral") {
    const membrosAleatorios = [...teamMembers]
      .sort(() => Math.random() - 0.5)
      .slice(0, 100);

    return (
      <div className={styles.containerGeral}>
        <div className={styles.groupSection}>
          <motion.h2
            className={styles.title}
            initial={{ opacity: 0, y: 40 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            viewport={{ once: true, amount: 0.8 }}
          >
            Conheça nossa equipe
          </motion.h2>

          <button
            aria-label="Slide anterior"
            ref={prevRef}
            className={`${styles.navButton} ${styles.navLeft}`}
          >
            <svg xmlns="http://www.w3.org/2000/svg" className={styles.navIcon} fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <button
            aria-label="Próximo Slide"
            ref={nextRef}
            className={`${styles.navButton} ${styles.navRight}`}
          >
            <svg xmlns="http://www.w3.org/2000/svg" className={styles.navIcon} fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </button>

          <Swiper
            onSwiper={(swiper) => {
              swiperRef.current = swiper;
              swiper.params.navigation.prevEl = prevRef.current;
              swiper.params.navigation.nextEl = nextRef.current;
              swiper.navigation.init();
              swiper.navigation.update();
              highlightPartialSlide(swiper);
            }}
            onSlideChange={(swiper) => highlightPartialSlide(swiper)}
            autoplay={{
              delay: 2000,
              disableOnInteraction: false,
            }}
            slidesPerGroup={2}
            spaceBetween={30}
            modules={[Navigation, Autoplay]}
            breakpoints={{
              0: { slidesPerView: 1 },
              480: { slidesPerView: 1.3 },
              640: { slidesPerView: 2 },
              768: { slidesPerView: 2.5 },
              1024: { slidesPerView: 3.5 },
              1280: { slidesPerView: 4.5 },
            }}
            className={styles.swiper}
          >
            {membrosAleatorios.map((membro) => (
              <SwiperSlide key={membro.id}>
                <Link to={`/equipe/${membro.id}`} className={styles.link}>
                  <div className={`${styles.grid} card`}>
                    <div className={styles.imageWrapper}>
                      <img
                        src={getImageUrl(membro.bg_url) || '/placeholder-bg.png'}
                        className={styles.bgImage}
                        onError={(e) => { e.target.src = '/placeholder-bg.png'; }}
                      />
                      <div className={styles.overlay}></div>
                    </div>
                    <div className={styles.contentInformation}>
                      <img
                        src={getImageUrl(membro.foto_url) || '/placeholder-avatar.png'}
                        alt={`Foto de ${membro.nome}`}
                        className={styles.memberImage}
                        onError={(e) => { e.target.src = '/placeholder-avatar.png'; }}
                      />
                      <h3 className={styles.nomeMembro}>{membro.nome}</h3>
                      <p className={styles.descricaoMembro}>{membro.descricao}</p>
                      <div className={styles.iconWrapper}>
                        <img
                          src={getImageUrl(membro.subgrupos?.[0]?.icone_url) || '/placeholder-icon.png'}
                          alt="Ícone do grupo"
                          className={styles.icon}
                          onError={(e) => { e.target.src = '/placeholder-icon.png'; }}
                        />
                      </div>
                    </div>
                  </div>
                </Link>
              </SwiperSlide>
            ))}
          </Swiper>
        </div>
      </div>
    );
  }

  // MODO GRUPOS (página equipe)
  const membroDestaque = teamMembers.find(m => m.id === 1);
  return (
    <div className={styles.containerGrupos}>
      <motion.h2
        className={styles.title}
        initial={{ opacity: 0, y: 40 }}
        whileInView={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6 }}
        viewport={{ once: true, amount: 0.8 }}
      >
        Conheça nossa equipe
      </motion.h2>

      {/*CARD DESTAQUE (ID = 1)*/}
      {membroDestaque && (
        <motion.section
          className={styles.membroDestaque}
          initial={{ opacity: 0, y: 40 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          viewport={{ once: true, amount: 0.8 }}
        >
          <Link to={`/equipe/${membroDestaque.id}`} className={styles.link}>
            <div className={`${styles.cardDestaque} card`}>
              <div className={styles.contentInformationDestaque}>
                <div className={styles.memberImageDestaque}>
                  <img
                    src={getImageUrl(membroDestaque.foto_url) || '/placeholder-avatar.png'}
                    alt={`Foto de ${membroDestaque.nome}`}
                    className={styles.bgImageDestaque}
                    onError={(e) => { e.target.src = '/placeholder-avatar.png'; }}
                  />
                </div>

                <div className={styles.textContentDestaque}>
                  <h3 className={styles.nomeMembro}>{membroDestaque.nome}</h3>
                  <h4 className={styles.descricaoMembro}>{membroDestaque.subgrupos?.[0]?.nome_grupo}</h4>
                  <div className={styles.iconWrapperDestaque}>
                    <img
                      src={getImageUrl(membroDestaque.subgrupos?.[0]?.icone_url) || '/placeholder-icon.png'}
                      alt="Ícone do grupo"
                      className={styles.icon}
                      onError={(e) => { e.target.src = '/placeholder-icon.png'; }}
                    />
                  </div>
                </div>
              </div>
            </div>
          </Link>
        </motion.section>
      )}

      {/*MEMBROS DO GRUPOS*/}
      {groupData.map((grupo) => {
        const membrosDoGrupo = teamMembers.filter(m =>
          m.subgrupos?.some(sg => sg.id === grupo.id) && m.id !== 1
        );

        if (membrosDoGrupo.length === 0) return null;

        return (
          <motion.section
            key={grupo.id}
            className={styles.groupSection}
            initial={{ opacity: 0, y: 40 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.7 }}
            viewport={{ once: true, amount: 0.4 }}
          >
            <motion.h2
              className={styles.groupTitle}
              initial={{ opacity: 0, y: 40 }}
              whileInView={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.1 }}
              viewport={{ once: true, amount: 0.8 }}
            >
              {grupo.nome_grupo}
            </motion.h2>

            <button
              aria-label='Slide anterior'
              ref={prevRef}
              className={`${styles.navButton} ${styles.navLeft}`}
            >
              <svg xmlns="http://www.w3.org/2000/svg" className={styles.navIcon} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <button
              aria-label='Próximo Slide'
              ref={nextRef}
              className={`${styles.navButton} ${styles.navRight}`}
            >
              <svg xmlns="http://www.w3.org/2000/svg" className={styles.navIcon} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>

            <Swiper
              onSwiper={(swiper) => {
                swiperRef.current = swiper;
                swiper.params.navigation.prevEl = prevRef.current;
                swiper.params.navigation.nextEl = nextRef.current;
                swiper.navigation.init();
                swiper.navigation.update();
                highlightPartialSlide(swiper);
              }}
              onSlideChange={(swiper) => highlightPartialSlide(swiper)}
              autoplay={{
                delay: 2000,
                disableOnInteraction: false,
              }}
              slidesPerGroup={2}
              spaceBetween={30}
              modules={[Navigation, Autoplay]}
              breakpoints={{
                0: { slidesPerView: 1 },
                480: { slidesPerView: 1.3 },
                640: { slidesPerView: 2 },
                768: { slidesPerView: 2.5 },
                1024: { slidesPerView: 3.5 },
                1280: { slidesPerView: 4.5 },
              }}
              className={styles.swiper}
            >
              {membrosDoGrupo.map((membro) => (
                <SwiperSlide key={membro.id}>
                  <Link to={`/equipe/${membro.id}`} className={styles.link}>
                    <div className={`${styles.grid} card`}>
                      <div className={styles.imageWrapper}>
                        <img
                          src={getImageUrl(membro.bg_url) || '/placeholder-bg.png'}
                          alt={`Background de ${membro.nome}`}
                          className={styles.bgImage}
                          onError={(e) => { e.target.src = '/placeholder-bg.png'; }}
                        />
                        <div className={styles.overlay}></div>
                      </div>
                      <div className={styles.contentInformation}>
                        <img
                          src={getImageUrl(membro.foto_url) || '/placeholder-avatar.png'}
                          alt={`Foto de ${membro.nome}`}
                          className={styles.memberImage}
                          onError={(e) => { e.target.src = '/placeholder-avatar.png'; }}
                        />
                        <h3 className={styles.nomeMembro}>{membro.nome}</h3>
                        <p className={styles.descricaoMembro}>{membro.descricao}</p>
                        <div className={styles.iconWrapper}>
                          <img
                            src={getImageUrl(grupo.icone_url) || '/placeholder-icon.png'}
                            alt="Ícone do grupo"
                            className={styles.icon}
                            onError={(e) => { e.target.src = '/placeholder-icon.png'; }}
                          />
                        </div>
                      </div>
                    </div>
                  </Link>
                </SwiperSlide>
              ))}
            </Swiper>
          </motion.section>
        );
      })}
    </div>
  );
};

export default Team;

